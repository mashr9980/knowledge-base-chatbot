<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sage Chat</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/css/chat.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTYiIGN5PSIxNiIgcj0iMTYiIGZpbGw9IiM2NjdlZWEiLz4KPHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHg9IjYiIHk9IjYiIGZpbGw9IndoaXRlIj4KPHA+QzwvcD4KPC9zdmc+Cjwvc3ZnPg==">
</head>
<body>
    <div class="chat-container">
        <!-- Sidebar -->
        <div class="chat-sidebar">
            <div class="sidebar-header">
                <div class="nav-brand">
                    <i class="fas fa-robot"></i>
                    <span>Sage Chat</span>
                </div>
                <button class="btn btn-small btn-primary" onclick="newChat()">
                    <i class="fas fa-plus"></i> New Chat
                </button>
            </div>

            <div class="document-selector">
                <label for="document-select"><i class="fas fa-file-alt"></i> Select Document:</label>
                <select id="document-select" onchange="onDocumentChange()">
                    <option value="">Loading documents...</option>
                </select>
            </div>

            <div class="chat-sessions">
                <h3><i class="fas fa-history"></i> Chat History</h3>
                <div id="sessions-list" class="sessions-list">
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
                        <p>Loading sessions...</p>
                    </div>
                </div>
            </div>

            <div class="sidebar-footer">
                <a href="/app" class="btn btn-outline btn-small">
                    <i class="fas fa-home"></i> Dashboard
                </a>
                <button class="btn btn-outline btn-small" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="chat-main">
            <div class="chat-header">
                <div class="chat-info">
                    <h3 id="chat-title">Sage Assistant</h3>
                    <p id="chat-status">Select a document to start chatting</p>
                </div>
                <div class="chat-actions">
                    <button class="btn btn-small btn-secondary" onclick="clearChat()" id="clear-btn" disabled>
                        <i class="fas fa-trash"></i> Clear
                    </button>
                </div>
            </div>

            <div class="chat-messages" id="chat-messages">
                <div class="welcome-message">
                    <div class="assistant-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="message-content">
                        <p>Hello! I'm Sage, your Enterprise Support Assistant. Please select a document from the sidebar to start our conversation.</p>
                        <p><strong>Quick Start:</strong></p>
                        <ul>
                            <li>üìÑ Choose a document from the dropdown</li>
                            <li>üí¨ Ask questions about the document content</li>
                            <li>üîç Get instant AI-powered answers</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <textarea 
                        id="chat-input" 
                        placeholder="Select a document first..." 
                        disabled
                        onkeypress="handleKeyPress(event)"
                        rows="1"
                    ></textarea>
                    <button 
                        id="send-btn" 
                        class="send-btn" 
                        onclick="sendMessage()" 
                        disabled
                        title="Send Message"
                    >
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <p class="input-hint">
                    <i class="fas fa-keyboard"></i> Press Enter to send, Shift+Enter for new line
                </p>
            </div>
        </div>
    </div>

    <!-- Connection Status -->
    <div id="connection-status" class="connection-status disconnected">
        <i class="fas fa-circle"></i>
        <span>Disconnected</span>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <h3>Loading Chat...</h3>
            <p>Please wait while we initialize your chat interface</p>
        </div>
    </div>

    <!-- Alert Messages -->
    <div id="alert-container" class="alert-container"></div>

    <!-- Scripts -->
    <script src="/static/js/main.js"></script>
    <script src="/static/js/chat.js"></script>
    
    <script>
        console.log('Sage Chat Interface initialized');
        
        // Add error handling
        window.addEventListener('error', function(e) {
            console.error('JavaScript Error:', e.error);
            if (typeof showAlert === 'function') {
                showAlert('An error occurred in the chat interface. Please refresh the page.', 'error');
            }
        });
        
        // Debug information
        console.log('Chat Interface URL:', window.location.href);
        console.log('API Base URL:', window.location.origin);
        
        // Handle textarea auto-resize
        document.addEventListener('DOMContentLoaded', function() {
            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                chatInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
                });
            }
        });
        
        // Add connection status styling
        const connectionStyles = `
            .connection-status {
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 0.5rem 1rem;
                border-radius: 20px;
                display: flex;
                align-items: center;
                gap: 0.5rem;
                font-size: 0.9rem;
                z-index: 1000;
                transition: all 0.3s ease;
            }
            
            .connection-status.connected {
                background: rgba(40, 167, 69, 0.9);
            }
            
            .connection-status.disconnected {
                background: rgba(220, 53, 69, 0.9);
            }
            
            .connection-status.connecting {
                background: rgba(255, 193, 7, 0.9);
                color: #212529;
            }
            
            .connection-status i {
                font-size: 0.8rem;
                animation: pulse 2s infinite;
            }
            
            .connection-status.connected i {
                animation: none;
            }
            
            @keyframes pulse {
                0% { opacity: 1; }
                50% { opacity: 0.5; }
                100% { opacity: 1; }
            }
            
            #chat-input {
                resize: none;
                overflow-y: auto;
                min-height: 40px;
                max-height: 120px;
                line-height: 1.4;
            }
            
            .chat-input-wrapper {
                position: relative;
            }
            
            .loading-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                display: none;
                justify-content: center;
                align-items: center;
                flex-direction: column;
                z-index: 9999;
                color: white;
                text-align: center;
            }
            
            .loading-overlay.active {
                display: flex;
            }
            
            .spinner {
                width: 40px;
                height: 40px;
                border: 4px solid rgba(255, 255, 255, 0.3);
                border-top: 4px solid white;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin: 0 auto 1rem;
            }
            
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        
        const styleSheet = document.createElement('style');
        styleSheet.textContent = connectionStyles;
        document.head.appendChild(styleSheet);
    </script>
</body>
</html>